---
categories:
  - Java
  - 知识库
  - 理解计算机
---
## 互联网背景

我们每天都在使用互联网上网冲浪，而网站的资源是部署在另台机器上的，那么处于两地的主机是如何通信的呢？

互联网的核心是一系列协议，总称为“互联网协议”。他们对电脑如何连接和组网，做出了详尽的规定。主机之间通信的时候，正是因为都遵从了这一系列协议，消息才正常从一方送达至另一方，且正确的理解对方发送消息的含义。

# 概述

## 互联网分层模型

互联网的实现分为很多层级，用户接触到的，只是最上面一层，如在主机上使用的桌面应用，浏览器网站，每次简单的界面操作，实际涉及到消息从最上一层一直逐层传递到最底层。

分层模型有多种，较容易理解的是五层模型，由上至下分为以下层级：

1. 应用层（用户接触的）
2. 传输层
3. 网络层
4. 链接层
5. 实体层



每一层都是为完成某种功能，而为实现这些功能，就需要共同遵从各层的规则，大家都遵从的规则，就叫做协议。



## 实体层

电脑要组网，首先要将电脑连接起来（光缆、电缆、无线电波等方式）。这个层级的内容称为“实体层“，它是把电脑连接起来的物理手段。这一层级主要规定了网络的一些电气特征（描述电流、电压等），作用是负责传送0/1的电信号。



## 链接层



### 链接层的定义

单纯的0/1电信号没有任何意义，必须规定解读方式：多少个电信号算一组？每个信号位有何意义？

链接层的功能就是为了确定电信号0和1的分组方式。



### 链接层之以太网协议

以太网协议是其中一种，也是最主流的电信号分组方式。

以太网规定，一组电信号构成一个数据包，叫做"帧"（Frame）。每一帧分成两个部分：标头（Head）和数据（Data）。

"标头"的长度，固定为18字节。"数据"的长度，最短为46字节，最长为1500字节。因此，整个"帧"最短为64字节，最长为1518字节。如果数据很长，就必须分割成多个帧进行发送。



### 链接层之MAC地址

发送者、接收者的标识：**MAC地址**

以太网规定，连入网络的所有设备，都必须具有"网卡"接口。数据包必须是从一块网卡，传送到另一块网卡。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。



MAC地址：machine access control 

长度是12个十六进制数，即48个二进制位(2^4)



### 链接层之广播



假设以太网数据包已经知道了接收方的mac地址。获取方式见详见ARP协议



以太网使用一种广播的方式，向本网络内所有 计算机发送数据包，让每台计算机判断是否为接收方，若为接收方则处理数据包，否则丢弃。

判断是否为接收方的方式是对比数据包的标头中包含的目标mac地址是否与自身的mac地址相同



### 链接层之ARP协议

（`Address Resolution Protocol`）ARP寻址是用在数据链路层上的。我们上网的电脑都有网卡。那么在数据链路层的进行传递的时候，是没有IP的概念，都是通过找到对端设备的硬件地址，也就是网卡地址来做传输。这个硬件地址标准称为MAC地址。寻找对方MAC地址的过程就是ARP寻址。



示例：局域网内，从192.168.0.5来ping下192.168.0.8。得到交互流程如下。

1 首先是一个ARP广播报文，由192.168.0.5发出，可以看到带的广播报文是who has 192.168.0.8 tell 192.168.0.5 （目标`MAC地址`是`FF-FF-FF-FF-FF-FF`）

2 随后192.168.0.8回复 192.168.0.8 is at 00:0C:29:DE:DF:87

3 找到MAC地址后，随后就是ping报文



计算机中会维护一个ARP缓存表（包含一个`寿命值`TTL，也称作生存时间），这个表记录着IP地址与MAC地址的映射关系，我们可以通过在电脑的控制台通过arp -a指令查看一下我们自己计算机的ARP缓存表。他们是主机`最近`运行时获得关于其他主机的`IP地址`到`MAC地址`的映射，当需要发送数据的时候，主机就会根据数据报中的`目标IP地址`信息，然后在ARP缓存表中进行查找对应的`MAC地址`，最后通过**网卡**将数据发送出去。



如果两台主机不在同一个子网络，那么事实上没有办法得到对方的MAC地址，只能把数据包传送到两个子网络连接处的"网关"（gateway），让网关去处理。



**ARP协议的主要工作就是建立、查询、更新、删除ARP表项。**



## 网络层

### 网络层之由来

以太网采用广播方式发送数据包，所有成员人手一"包"，不仅效率低，而且局限在发送者所在的子网络。也就是说，如果两台计算机不在同一个子网络，广播是传不过去的。

如果是同一个子网络，就采用广播方式发送，否则就采用"路由"方式发送。MAC地址本身无法做到这一点。它只与厂商有关，与所处网络无关。所以就引出了“网络层”之“网络地址”的出现。

网络地址是管理员分配的，mac地址是绑定在网卡上的。

网络地址帮助我们确定计算机所在的子网络，MAC地址则将数据包送到该子网络中的目标网卡。即需先处理网络地址，然后再处理MAC地址。



### 网络层之IP地址

规定网络地址的协议，叫做IP协议。它所定义的地址，就被称为IP地址。

网络地址/IP地址：IP协议第四版IPv4规定地址由32个二进制位组成，习惯上分为四段十进制数。

IP地址包含网络部分和主机部分。处于同一个自网络的主机，IP地址的网络部分必定相同。那如何判断网络部分呢？使用子网掩码，网络部分为1，主机部分为0。

判断任意两个IP地址是否处在同一个子网络。方法是将两个IP地址与子网掩码分别进行AND运算（两个数位都为1，运算结果为1，否则为0），然后比较结果是否相同，如果是的话，就表明它们在同一个子网络中，否则就不是。



## 传输层

### 传输层之由来

有了MAC地址和IP地址，我们已经可以在互联网上任意两台主机上建立通信。但是每台主机上又运行着多个应用程序，那如何知道数据包是发送到哪个应用程序上的呢？也就是说，我们还需要一个参数，表示这个数据包到底供哪个程序（进程）使用。这个参数就叫做"端口"（port），它其实是每一个使用网卡的程序的编号。

**"传输层"的功能，就是建立"端口到端口"的通信。相比之下，"网络层"的功能是建立"主机到主机"的通信。只要确定主机和端口，我们就能实现程序之间的交流。**

"端口"是0到65535之间的一个整数，正好16个二进制位。0到1023的端口被系统占用，用户只能选用大于1023的端口。



### 传输层之TCP&UDP协议

UDP协议的优点是比较简单，容易实现，但是缺点是可靠性较差，一旦数据包发出，无法知道对方是否收到。

TCP协议能够确保数据不会遗失。它的缺点是过程复杂、实现困难、消耗较多的资源。



## 应用层

应用程序收到"传输层"的数据，接下来就要进行解读。由于互联网是开放架构，数据来源五花八门，必须事先规定好格式，否则根本无法解读。

**"应用层"的作用，就是规定应用程序的数据格式。**



## 数据包最终组成

![avatar]([https://gitee.com/huangyuye/Self-DocBlog/blob/master/%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA/%E6%95%B0%E6%8D%AE%E5%8C%85.png](https://gitee.com/huangyuye/Self-DocBlog/blob/master/理解计算机/数据包.png)



## 新计算机上网设置

  * 本机的IP地址

  * 子网掩码

  * 网关的IP地址

  * DNS的IP地址

    

### 动态IP地址

"动态IP地址"，指计算机开机后，会自动分配到一个IP地址，不用人为设定。它使用的协议叫做[DHCP协议](http://zh.wikipedia.org/zh/DHCP)。

这个协议规定，每一个子网络中，有一台计算机负责管理本网络的所有IP地址，它叫做"DHCP服务器"。新的计算机加入网络，必须向"DHCP服务器"发送一个"DHCP请求"数据包，申请IP地址和相关的网络参数。

但是局域网内的计算机发送数据包，必须知道目标主机的MAC地址和IP地址，新加入的计算机不知道DHCP服务器的这两个地址，怎么发送数据包呢？



DHCP协议做了一些巧妙的规定，规定如下：

首先，DHCP协议是一种**应用层**协议，建议在UDP之上。DHCP‘应用数据包组成为

（1）最前面的"以太网标头"，设置发出方（本机）的MAC地址和接收方（DHCP服务器）的MAC地址。前者就是本机网卡的MAC地址，后者这时不知道，就填入一个广播MAC地址：FF-FF-FF-FF-FF-FF。

（2）后面的"IP标头"，设置发出方的IP地址和接收方的IP地址。这时，对于这两者，本机都不知道。于是，发出方的IP地址就设为0.0.0.0，接收方的IP地址设为255.255.255.255。

（3）最后的"UDP标头"，设置发出方的端口和接收方的端口。这一部分是DHCP协议规定好的，发出方是68端口，接收方是67端口。

数据包构造完成发出，流程如下：

因为接收方的MAC地址是FF-FF-FF-FF-FF-FF，看不出是发给谁的，所以每台收到这个包的计算机，还必须分析这个包的IP地址，才能确定是不是发给自己的。当看到发出方IP地址是0.0.0.0，接收方是255.255.255.255，于是DHCP服务器知道"这个包是发给我的"，而其他计算机就可以丢弃这个包。

接下来，DHCP服务器读出这个包的数据内容，分配好IP地址，发送回去一个"DHCP响应"数据包。这个响应包的结构也是类似的，以太网标头的**MAC地址**是双方的网卡地址，IP标头的IP地址是DHCP服务器的IP地址（发出方）和255.255.255.255（接收方），UDP标头的端口是67（发出方）和68（接收方），分配给请求端的IP地址和本网络的具体参数则包含在Data部分。

新加入的计算机收到这个响应包，于是就知道了自己的IP地址、子网掩码、网关地址、DNS服务器等等参数。



## 参考链接

阮一峰—互联网协议入门：

http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html

http://www.ruanyifeng.com/blog/2012/06/internet_protocol_suite_part_ii.html